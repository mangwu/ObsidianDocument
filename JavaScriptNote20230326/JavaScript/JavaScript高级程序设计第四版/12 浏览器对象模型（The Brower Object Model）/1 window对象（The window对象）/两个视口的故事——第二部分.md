# 两个视口的故事——第二部分

在这个小系列中，我将解释视口和各种重要元素的宽度是如何工作的，例如＜html＞元素，以及窗口和屏幕。

> 在这一部分，我们将谈论移动浏览器。如果你对手机完全陌生，我建议你先阅读关于桌面浏览器的第一部分，以便在熟悉的环境中奠定基础。
> 

# 移动浏览器的问题

当我们将移动浏览器与桌面浏览器进行比较时，最明显的区别是屏幕大小。移动浏览器的缺少像桌面浏览器那样的网站显示优化方式；要么缩小到文本小得无法阅读，要么只显示适合屏幕的网站的一小部分；（移动浏览器）要么缩小到文本小到难以阅读，要么只显示适合屏幕的网站的一小部分。

手机屏幕比桌面屏幕小得多；最大宽度为400px，有时甚至更小。(有些手机报告的宽度更大，但它们在撒谎——或者至少给了我们无用的信息。)（**注**：最大宽度为400px是在过去环境下的说法，但苹果手机的屏幕像素宽度仍然在400px左右）

手机与电脑之间的中间层设备，如iPad或传闻中基于惠普web-OS的平板电脑，将弥合台式机和移动设备之间的差距，但这并不能改变根本问题。网站也必须在移动设备上运行，所以我们必须让它们在小屏幕上显示良好。

最重要的问题集中在CSS上，尤其是视口的尺寸。如果我们一对一地复制桌面模型，我们的CSS就会开始严重失灵。

让我们回到设置了`width: 100%`的侧边栏。如果移动浏览器的功能与桌面浏览器完全相同，那么侧边栏元素的宽度最大为40px，这太窄了。你的液体布局会被严重挤压。

解决这个问题的一种方法是为移动浏览器建立一个专门的网站。这样做的原因除了可以从根本上解决网站自适应问题外，在实际开发中，只有极少数网站所有者有足够的知识来专门做双端的自适应

移动浏览器供应商希望为他们的客户提供尽可能好的体验，这意味着“尽可能像桌面”。

# 两个视口

移动设备的视口太窄，无法作为CSS布局的基础。显而易见的解决方案是使视口更宽。也就是说，这需要将视口分为两类：**视觉视口和布局视口（visual viewport and layout viewport）**。

乔治·卡明斯（George Cummins）在[堆栈溢出](https://stackoverflow.com/questions/6333927/difference-between-visual-viewport-and-layout-viewport)（Stack Overflow，一个程序猿交流社区）中对这两个基本概念做了最好的解释：

> ”将**布局视口**想象为不改变大小或形状的大图像。现在，想象有一个较小的框架（small frame），通过它可以看到大图像。小框架被不透明的材料包围，这些‘材料’遮挡大图像中的视图而保留了大图像的一部分。可以通过框架看到的大图像的那**部分（portion）**称为**视觉视口**。您可以在拉远框架也就是进行缩放（zoom out），以便一次看到整个图像，或者您可以拉近框架也就是进行放大（zoom in），以便只看到一部分。您也可以更改框架的方向，但大图像（布局视口）的大小和形状永远不会更改。“
> 

**视觉视口**是当前显示在屏幕上的页面的一部分。用户可以滚动以更改他看到的页面部分，或者缩放以更改**视觉视口**的大小。

![mobile_visualviewport.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_visualviewport.jpg)

然而，CSS布局，特别是百分比宽度，是**相对于布局视口**计算的，布局视口比视觉视口宽得多。

因此，**＜html＞元素最初采用布局视口的宽度**，并且您的CSS被解释时参考的宽度比实际手机屏幕更宽。这可以确保站点的布局与桌面浏览器上的布局一样。

布局视口有多宽？每个浏览器的情况不同。Safari iPhone使用980像素、Opera 850像素、Android WebKit 800像素和IE 的974像素。

某些浏览器具有特殊行为：

- Symbian WebKit试图保持布局视口与视觉视口相等，是的，这意味着具有百分比宽度的元素可能会表现异常。但是，如果页面由于绝对宽度而不适合视觉视口，浏览器会将布局视口扩展到最大850px。
- Samsung WebKit（在bada上）使布局视口与最宽的元素一样宽。
- 在BlackBerry上，布局视口等于100%缩放时的视觉视口。这不会改变。

## 缩放（Zooming）

显然，这两个视口都是以CSS像素度量的。但是，当视觉视口尺寸随着缩放而改变时（如果放大，屏幕上的CSS像素会减少），布局视口尺寸保持不变。（如果布局尺寸变化，会导致您的页面将随着百分比宽度的重新计算而不断进行页面排版。）

## 理解布局视口

为了了解布局视口的大小，我们必须查看页面完全缩小时发生的情况。许多移动浏览器最初以完全缩小模式显示任何页面。

重点是：如果浏览器选择了布局视口的尺寸，会使其在**完全缩小模式（fully zoomed-out mode）**下完全覆盖屏幕（因此与视觉视口相同）。

![mobile_viewportzoomedout.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_viewportzoomedout.jpg)

因此，布局视口的宽度和高度等于在最大缩小模式下屏幕上可以显示的任何内容。当用户放大时，这些布局视口保持不变。

![mobile_layoutviewport.jpg](mobile_layoutviewport.jpg)

布局视口宽度始终相同。如果旋转手机，视觉视口会发生变化，但浏览器会通过略微放大以使布局视口再次与视觉视口一样宽来适应此新方向。

![mobile_viewportzoomedout_la.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_viewportzoomedout_la.jpg)

这会对布局视口的高度产生影响，该高度现在大大低于纵向模式。但网络开发人员**不在乎高度，只在乎宽度**。

![mobile_layoutviewport_la.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_layoutviewport_la.jpg)

# 测量布局视口

现在我们有两个要测量的视口。因此，浏览器大战给了我们两个属性对，这是非常幸运的。

`document.documentElement.clientWidth/Height`包含布局视口的尺寸。

![mobile_client.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_client.jpg)

方向与高度有关，但与宽度无关。（也就是说布局宽度不会因为设备方向变化而变大或变小）

![mobile_client_la.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_client_la.jpg)

# 测量视觉视口

至于视觉视口，它是通过`window.innerWidth/Height`来测量的。显然，当用户缩小或放大时，测量值会发生变化，因为屏幕上可以容纳更多或更少的CSS像素。

![mobile_inner.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_inner.jpg)

不幸的是，这是一个不兼容的领域；许多浏览器仍然需要添加对视觉视口测量的支持。尽管如此，没有浏览器将此度量存储在任何其他属性对中，所以我猜window.innerWidth/Height是一个标准，尽管支持得很差。

# 屏幕

与桌面一样，`screen.width/height`以**设备像素**为单位显示屏幕大小。与桌面一样，作为web开发人员，您永远不需要这些信息。您对屏幕的物理大小不感兴趣，而是对屏幕上当前有多少CSS像素感兴趣。

![mobile_screen.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_screen.jpg)

## 缩放级别

直接读取缩放级别是不可能的，但您可以通过**将`screen.width`除以`window.innerWidth`得到它**。当然，只有在两个属性都得到完美支持的情况下，这才有效。

幸运的是，缩放级别并不重要。您需要知道的是屏幕上当前有多少CSS像素。如果移动浏览器正确支持，您可以从`window.innerWidth`获取该信息。

# 滚动偏移量

您还需要知道视觉视口相对于布局视口的当前位置。这是滚动偏移量，就像在桌面上一样，它存储在`window.pageX/YOffset`中。

![mobile_page.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_page.jpg)

# <html>元素

就像在桌面上一样，`document.documentElement.offsetWidth/Height`以CSS像素表示<html>元素的总大小。

![mobile_offset.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_offset.jpg)

# 媒介查询

媒体查询的工作方式与桌面相同。**width/height使用布局视口**作为参考，并以CSS像素测量，**device-width/height**则使用设备屏幕，并以设备像素测量。

换句话说，width/height反映了文档的值：`documentElement.clientWidth/Height`，而`device-width/Height`反应了屏幕的值：`screen.width/height`。（实际上，在所有浏览器中都会这样做，即使反应的值不正确。）

![mobile_mediaqueries.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_mediaqueries.jpg)

现在哪种度量对我们web开发人员更有用？我不知道。

我开始认为设备宽度是最重要的，因为它提供了我们可能可以使用的设备的一些信息。例如，可以改变布局的宽度以适应设备的宽度。但是，您也可以使用`<meta-viewport>`；使用`device-width`媒体查询不是绝对必要的。

那么，宽度到底是不是更重要的媒体查询？这也许能让浏览器供应商思考当前设备上，网站的什么宽度合适。但这相当模糊，而且`width`媒体查询实际上没有提供任何其他信息。

所以我还没有决定。目前，我认为媒体查询对于确定您是在台式机、平板电脑还是移动设备上很重要，但对于区分各种平板电脑或移动设备并不是很有用。

# 事件坐标

事件坐标的工作方式或多或少与桌面相同。不幸的是，在十二个测试过的浏览器中，只有两个，Symbian WebKit和Iris，三个都完全正确。所有其他浏览器都或多或少存在严重问题。

`pageX/Y`仍然是相对于页面的CSS像素值（布局视口），这是迄今为止三个属性对中最有用的，就像它在桌面上一样。

![mobile_pageXY.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_pageXY.jpg)

`clientX/Y` 是相对于视觉视口的坐标像素值。这样定义是合理的，尽管我不完全确定它有什么好处。

`screenX/Y` 是相对于屏幕的设备像素值。当然，这与`clientX/Y` 表达相同的含义，但是设备像素是无用的。所以我们不需要担心屏幕X/Y；它和桌面一样毫无用处。

![mobile_clientXY.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mobile_clientXY.jpg)

# 视口元信息标签（Meta Viewport）

最后，让我们讨论`<meta name=“viewport”content=“width=320”>`；最初是苹果的扩展，但同时被更多的浏览器复制。它用于调整布局视口的大小。为了理解为什么这是必要的，让我们后退一步。

假设您构建一个简单的页面，并且不给元素宽度。现在，它们将拉伸到布局视口宽度的100%。大多数浏览器缩小以在屏幕上显示整个布局视口，产生如下效果：

![mq_none.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mq_none.jpg)

所有用户都会立即进行放大操作才能看的清楚，但大多数浏览器保持元素的宽度不变（因为它们还在布局视口中），这使得文本难以阅读。

![mq_none_zoomed.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mq_none_zoomed.jpg)

（这里的一个重要例外是Android WebKit，它实际上减小了包含元素的文本的大小，使其适合屏幕。这是非常棒的，我觉得所有其他浏览器都应该复制这种行为。我稍后会将其完全记录下来。）

现在，您可以尝试设置`html {width:320px}` (以解决上述问题)，但现在＜html＞元素缩小了，所有其他元素都缩小了，现在占320px的100%。这只在用户放大时有效，而不是在初始时默认有效；在用户面对的是一个缩小的页面，其中大部分内容都是无效区域

![mq_html300.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mq_html300.jpg)

正是为了解决这个问题，苹果发明了元视口标签。当您设置<meta name=“viewport”content=“width=320”>时，您将布局视口的宽度设置为320px。现在页面的初始状态也是正确的。

![mq_yes.jpg](%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%8F%A3%E7%9A%84%E6%95%85%E4%BA%8B%E2%80%94%E2%80%94%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/mq_yes.jpg)

可以将布局视口的宽度设置为所需的任何尺寸，包括`device-width`。最后一种图以`screen.width`（以设备像素为单位）为参考，并相应地调整布局视口的大小。

不过这里有一个陷阱。有时，正式的`screen.width`没有太多意义，因为像素数太高。例如，Nexus One的正式宽度为480px，但谷歌工程师认为，在使用设备宽度时，将布局视口的宽度设为480px实在太过了。他们将其缩小到2/3，因此设备宽度为320像素，与iPhone一样。

如果像传言的那样，新款iPhone将采用更大的像素数（这不一定等于更大的屏幕！），如果苹果复制这种行为，我不会感到惊讶。也许在终端`device-width`仍然是320px。

# 相关研究

需要进一步研究几个相关主题：

- `position: fixed`。我们知道，固定元素相对于视口定位。但相对于哪个视口？我同时做了[这项研究](https://www.quirksmode.org/blog/archives/2010/12/the_fifth_posit.html)
- 其他媒体查询：dpi、方向、纵横比。dpi尤其是一个灾难区域，不仅因为所有浏览器都报告96dpi（通常都是错误的），而且因为我还不完全确定哪个值对web开发人员最重要。
- 当元素比布局视口/HTML元素宽时会发生什么？假设我在一个测试页面中插入一个宽度为1500px的元素？元素将突出HTML元素（[`overflow](https://quirksmode.org/css/css2/overflow.html)：visible`），但这意味着实际视口可能会比布局视口更宽。此外，当这种情况发生时，旧的Android（Nexus One）放大了HTML元素。这是个好主意吗？