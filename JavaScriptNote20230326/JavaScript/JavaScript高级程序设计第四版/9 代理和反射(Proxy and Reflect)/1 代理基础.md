# 1. ä»£ç†åŸºç¡€

**ä»£ç†ï¼ˆProxyï¼‰æ˜¯ç›®æ ‡å¯¹è±¡çš„æŠ½è±¡ï¼Œ**ä¸å…¶å®ƒè¯­è¨€è¿›è¡Œç±»æ¯”ï¼Œä»£ç†å°±åƒæ˜¯C++æŒ‡é’ˆï¼Œå› ä¸ºå®ƒ**å¯ç”¨ä½œç›®æ ‡å¯¹è±¡çš„æ›¿èº«ï¼Œä½†åˆå®Œå…¨ç‹¬ç«‹äºç›®æ ‡å¯¹è±¡**

ç›®æ ‡å¯¹è±¡å¯ä»¥ç›´æ¥è¢«æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»£ç†æ¥æ“ä½œï¼Œä½†æ˜¯ç›´æ¥æ“ä½œä¼šç»•è¿‡ä»£ç†æ–½äºˆçš„è¡Œä¸º

**æ³¨æ„** ESä¸­çš„ä»£ç† å’Œ C++ ä¸­çš„æŒ‡é’ˆæœ‰é‡å¤§çš„åŒºåˆ«, ä¸Šè¿°åªæ˜¯åšä¸€ç§æœ‰åŠ©äºç†è§£çš„å¯¹æ¯”ï¼ŒæŒ‡é’ˆåœ¨æ¦‚å¿µä¸Šæ˜¯ç±»æ¯”æ¯”è¾ƒåˆé€‚çš„ç»“æ„

# 1.0 MDN-`Proxy` å†…ç½®å¯¹è±¡çš„æè¿°

[Proxy](1%20%E4%BB%A3%E7%90%86%E5%9F%BA%E7%A1%80/Proxy.md)

# 1.1 åˆ›å»ºç©ºä»£ç†

- ç©ºä»£ç†ï¼Œå°±æ˜¯**ä¸æ‹¦æˆª**ä»»ä½•æ“ä½œï¼Œåœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šæ— éšœç¢çš„**è½¬å‘**ï¼ˆ**forward**ï¼‰åˆ°ç›®æ ‡å¯¹è±¡ä¸Šï¼Œç©ºä»£ç†åˆç§°**æ— æ“ä½œè½¬å‘ä»£ç†ï¼ˆno-op forwarding proxyï¼‰**
- åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨ç›®æ ‡å¯¹è±¡çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥é€šè¿‡åŒæ ·çš„æ–¹å¼ä½¿ç”¨ä¸ä¹‹å…³è”çš„**æ— æ“ä½œè½¬å‘ä»£ç†**

**Proxyè¯­æ³•**

- `Proxy` æ˜¯ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹
    
    ```jsx
    new Proxy(target, handler);
    ```
    
    - `target` : ç›®æ ‡å¯¹è±¡ï¼Œæˆ–ç§° è¢«ä»£ç†çš„æºå¯¹è±¡
    - `handler` ï¼šå¤„ç†ç¨‹åºå¯¹è±¡ï¼Œå®šä¹‰ä»£ç†éœ€è¦æ‹¦æˆªï¼ˆinterceptï¼‰çš„ä¸€äº›æ“ä½œä»¥åŠ**é‡æ–°å®šä¹‰**ï¼ˆ**redefine**ï¼‰**æ‹¦æˆªä¸‹æ¥çš„æ“ä½œ**ï¼ˆ**intercepted operations**ï¼‰
- åˆ›å»ºç©ºä»£ç†ï¼šä¼ é€’ä¸€ä¸ªç®€å•å¯¹è±¡å­—é¢é‡ä½œä¸ºå¤„ç†ç¨‹åºå¯¹è±¡ï¼Œä»è€Œè®©æ‰€æœ‰æ“ä½œç•…é€šæ— é˜»åœ°æŠµè¾¾ç›®æ ‡å¯¹è±¡

**ä¾‹å­**

- ä¸‹é¢ä»£ç ï¼Œåœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œåœ°ä»»ä½•æ“ä½œéƒ½ä¼šå®é™…è½¬å‘åˆ°ç›®æ ‡å¯¹è±¡ä¸Šï¼Œå”¯ä¸€æ„ŸçŸ¥çš„ä¸åŒå°±æ˜¯ä»£ç ä¸­æ“ä½œçš„æ˜¯ä»£ç†å¯¹è±¡è€Œéç›®æ ‡å¯¹è±¡
    
    ```jsx
    // ç©ºä»£ç†
    const target = {
      id: "target",
    };
    
    // æ— æ“ä½œè½¬å‘ä»£ç†
    const proxy = new Proxy(target, {});
    
    // åœ¨proxyä¸Šçš„å¯¹è±¡æ“ä½œä¼šè½¬å‘åˆ°targetä¸Š
    console.log(proxy.id); // target
    console.log(target.id); // target
    
    proxy.id = "foo";
    
    console.log(proxy.id); // foo
    console.log(target.id); // foo
    
    // ä½¿ç”¨æ–¹æ³•åˆ¤æ–­ä»£ç†æ˜¯å¦åŒ…å«idå±æ€§ï¼Œä»£ç†ä¼šå°†æ”¹åˆ¤æ–­æ“ä½œè½¬å‘åˆ°ç›®æ ‡å¯¹è±¡ä¸Š
    console.log(target.hasOwnProperty("id")); // true
    console.log(proxy.hasOwnProperty("id")); // true
    
    // Proxy.prototypeæ˜¯undefined,å› æ­¤ä¸èƒ½ä½¿ç”¨instanceof åˆ¤æ–­ä»£ç†
    // ä»£ç†å®ä¾‹çš„åŸå‹[[Prototype]]æ˜¯Object.prototype(è¿™ä¹Ÿæ˜¯èƒ½ä½¿ç”¨hasOwnPropertyçš„åŸå› )
    try {
      console.log(proxy instanceof Proxy);
    } catch (error) {
      console.log(error.toString()); 
    // TypeError: Function has non-object prototype 'undefined' in instanceof check
    }
    console.log(proxy.__proto__ === Object.prototype); // true
    
    // ä»£ç†å’Œæºå¯¹è±¡æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œåªæ˜¯æ“ä½œç©ºä»£ç†èƒ½å°†æ“ä½œè½¬å‘åˆ°æºå¯¹è±¡ä¸Š
    console.log(target === proxy); // false
    ```
    

# 1.2 å®šä¹‰æ•è·å™¨

**ç†è§£æ•è·å™¨**

- **æ•è·å™¨ï¼Œtrapï¼Œ**å®ƒæ˜¯å®šä¹‰åœ¨**å¤„ç†ç¨‹åºå¯¹è±¡**ï¼ˆ**handler**ï¼‰ä¸Šçš„ç”¨äº**æ‹¦æˆª**ï¼ˆ**intercept**ï¼‰å¯¹æºå¯¹è±¡çš„æ“ä½œï¼Œå¹¶é‡æ–°å®šä¹‰æ‹¦æˆªä¸‹æ¥çš„æ“ä½œï¼ˆ**intercepted operations**ï¼‰ï¼›
- å¯¹ä»£ç†è¿›è¡Œçš„æ“ä½œç»è¿‡æ‹¦æˆªåä¼šè¢«é‡æ–°å®šä¹‰å¹¶è½¬å‘åˆ°æºå¯¹è±¡ä¸Šå†è¿›è¡Œä¿®æ­£æ“ä½œï¼Œè€Œæ‹¦æˆªå¹¶ä¿®æ”¹å¯¹è±¡çš„åŸºæœ¬æ“ä½œçš„å‡½æ•°å°±æ˜¯**æ•è·å™¨ï¼ˆtrapï¼‰**ï¼Œå®ƒä»¬éƒ½å®šä¹‰åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­
- æ¯ä¸ªå¤„ç†ç¨‹åºå¯¹è±¡ï¼ˆhandlerï¼‰å¯ä»¥åŒ…æ‹¬0ä¸ªæˆ–å¤šä¸ªæ•è·å™¨ï¼Œæ¯ä¸ªæ•è·å™¨å¯¹åº”ä¸€ç§åŸºæœ¬çš„æ“ä½œï¼Œå¯ä»¥ç›´æ¥æˆ–é—´æ¥åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨
- æ¯æ¬¡åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨è¿™äº›åŸºæœ¬æ“ä½œæ—¶ï¼Œä»£ç†ä¼š**å…ˆè°ƒç”¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­çš„æ•è·å™¨å‡½æ•°**ï¼Œæ‹¦æˆªéƒ¨åˆ†æ“ä½œï¼Œå¹¶ä¿®æ”¹ç›¸åº”çš„è¡Œä¸ºï¼Œå…¶å®ƒæœªè¢«æ‹¦æˆªçš„æ“ä½œä»ç„¶ä¼šè¢«è½¬å‘åˆ°ç›®æ ‡å¯¹è±¡â€˜

<aside>
ğŸ’¡ æ³¨æ„ï¼šæ•è·å™¨æ˜¯ä»æ“ä½œç³»ç»Ÿä¸­å€Ÿç”¨çš„æ¦‚å¿µã€‚åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæ•è·å™¨æ˜¯ç¨‹åºæµä¸­çš„ä¸€ä¸ªåŒæ­¥ä¸­æ–­ï¼Œå¯ä»¥æš‚åœç¨‹åºæµï¼Œè½¬è€Œæ‰§è¡Œä¸€æ®µå­ä¾‹ç¨‹ï¼Œä¹‹åå†è¿”å›åŸå§‹ç¨‹åºæµ

</aside>

**æ‰€æœ‰æ•è·å™¨**

- è¿™é‡Œåªåˆ—å‡ºæ‰€æœ‰çš„æ•è·å™¨ï¼Œè¯¦ç»†ä»‹ç»å†ç¬¬äºŒç« 

| trap(æ•è·å™¨æ–¹æ³•) | descriptionï¼ˆç®€å•æè¿°ï¼‰ |
| --- | --- |
| handler.apply() | æ‹¦æˆªæºå¯¹è±¡çš„å‡½æ•°è°ƒç”¨ |
| handler.construct() | new æ“ä½œç¬¦çš„æ•è·å™¨ï¼Œnew target ä¸€å®šè¦åˆæ³•æ‰èƒ½è¢«æ‹¦æˆªï¼Œæ‰€ä»¥target ä¸€èˆ¬æ˜¯æ„é€ å‡½æ•°æˆ–ç±»ï¼ˆæœ‰[[Construct]]å†…éƒ¨æ–¹æ³•ï¼‰ |
| handler.defineProperty() | æ‹¦æˆªæºå¯¹è±¡å®šä¹‰å±æ€§çš„æ“ä½œï¼Œå®ƒæ˜¯Object.defineProperty() çš„æ•è·å™¨ |
| handler.deleteProperty() | æ‹¦æˆªæºå¯¹è±¡åˆ é™¤å±æ€§çš„æ“ä½œï¼Œå®ƒæ˜¯delete æ“ä½œç¬¦çš„æ•è·å™¨ |
| handler.get() | æ‹¦æˆªæºå¯¹è±¡è·å–å±æ€§å€¼çš„æ“ä½œ |
| handler.getOwnPropertyDescriptor() | æ‹¦æˆªæºå¯¹è±¡è·å–å±æ€§çš„å±æ€§æè¿°ç¬¦çš„æ“ä½œï¼Œä»–æ˜¯Object.getOwnPropertyDescriptor() çš„æ•è·å™¨ |
| handler.getPrototypeOf() | æ‹¦æˆªæºå¯¹è±¡è·å–è‡ªèº«åŸå‹çš„æ“ä½œï¼Œå®ƒæ˜¯Object.getPrototypeOf() çš„æ•è·å™¨ |
| handler.has() | æ‹¦æˆªæºå¯¹è±¡åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸€å±æ€§çš„æ“ä½œï¼Œå®ƒæ˜¯in æ“ä½œç¬¦çš„æ•è·å™¨ |
| handler.isExtensible() | æ‹¦æˆªæºå¯¹è±¡åˆ¤æ–­è‡ªèº«æ˜¯å¦æ˜¯å¯æ‰©å±•çš„æ“ä½œï¼Œå®ƒæ˜¯Obejct.isExtensible() çš„æ•è·å™¨ |
| handler.ownKeys() | æ‹¦æˆªæºå¯¹è±¡è·å–è‡ªèº«æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬ç¬¦å·å±æ€§ï¼‰çš„æ“ä½œï¼Œå®ƒæ˜¯Reflect.ownKeys() çš„æ•è·å™¨ |
| handler.preventExtensions() | æ‹¦æˆªæºå¯¹è±¡å°†è‡ªèº«å˜ä¸ºä¸å¯æ‰©å±•çš„æ“ä½œï¼Œ å®ƒæ˜¯Object.preventExtensions() çš„æ•è·å™¨ |
| handler.set() | æ‹¦æˆªå¯¹è±¡è®¾ç½®å±æ€§å€¼çš„æ“ä½œ |
| handler.setPrototypeOf() | æ‹¦æˆªå¯¹è±¡è®¾ç½®è‡ªèº«åŸå‹çš„æ“ä½œï¼Œå®ƒæ˜¯Object.setPrototypeOf()çš„æ•è·å™¨ |

**ä¾‹å­**

- æœ€ç®€å•çš„ä¾‹å­å°±æ˜¯å®šä¹‰ä¸€ä¸ª`handler.get()` æ•è·ï¼Œè®©ä»£ç†æ‹¦æˆªå¯¹è±¡çš„è®¿é—®å±æ€§
    
    ```jsx
    // å®šä¹‰æ•è·å™¨
    const target = {
      message: "hello, world",
    };
    
    const handler = {
      // getæ•è·å™¨
      get() {
        return "handler override";
      },
    };
    
    const proxy = new Proxy(target, handler);
    ```
    
- è¿™æ ·ä½†é€šè¿‡ä»£ç†æƒ³è¦è¿›è¡Œæºå¯¹è±¡å±æ€§çš„è®¿é—®æ—¶ï¼Œå°±ä¼šè§¦å‘å®šä¹‰çš„`get()` æ•è·å™¨
- è®¿é—®å¯¹è±¡çš„å±æ€§æœ‰å¯ä»¥é€šè¿‡å¤šç§å½¢å¼è§¦å‘å¹¶è¢«`get()` æ•è·å™¨æ‹¦æˆªåˆ°ï¼Œä¾‹å¦‚`proxy[prop]`ã€`proxy.prop`ã€`Object.create(proxy)[prop]`ç­‰æ“ä½œéƒ½ä¼šè§¦å‘åŸºæœ¬çš„`get`æ“ä½œä»¥è·å–å±æ€§ï¼Œæ‰€ä»¥è¿™äº›è®¿é—®æ“ä½œåªè¦å‘ç”Ÿå†ä»£ç†å¯¹è±¡ä¸Šå°±ä¼šè§¦å‘`get()` æ•è·å™¨ï¼Œåœ¨æºå¯¹è±¡è®¿é—®å±æ€§ä»ç„¶æ˜¯æ­£å¸¸çš„è¡Œä¸º
    
    ```jsx
    const proxy = new Proxy(target, handler);
    
    console.log(target.message); // hello, world
    console.log(proxy.message); // handler override
    
    console.log(Object.create(target).message); // hello, world
    console.log(Object.create(proxy).message); // handler override
    ```
    

# 1.3 æ•è·å™¨å‚æ•°å’Œåå°„API

## 1.3.1 æ•è·å™¨å‚æ•°

- æ•è·å™¨æ–¹æ³•æ˜¯æœ‰é»˜è®¤å‚æ•°çš„ï¼ŒåŸºäºè¿™äº›å‚æ•°å¯ä»¥**é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º**æˆ–**è‡ªå®šä¹‰å…¶å®ƒè¡Œä¸º**
- `handler.get()` å…·æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚ä¸‹
    
    ```jsx
    get(target, prop, receiver)
    ```
    
    - `target` æ•è·å™¨æ¥å—åˆ°çš„ç›®æ ‡å¯¹è±¡ï¼ˆä»£ç†å…³è”çš„æºå¯¹è±¡ï¼‰
    - `prop` è¦æŸ¥è¯¢çš„å±æ€§åç§°
    - `receiver` ä»£ç†å¯¹è±¡æˆ–ç»§æ‰¿ä»£ç†çš„å¯¹è±¡

**ä¾‹å­**

```jsx
const target = {
  foo: "foo",
};
const handler = {
  get(trapTarget, prop, receiver) {
    console.log(trapTarget === target);
    console.log(prop);
    console.log(receiver === proxy);
  },
};
const proxy = new Proxy(target, handler);
proxy.foo;
// æ‰“å°
true
foo
true
```

- ä¸Šè¿°ä¾‹å­è¯´æ˜äº†ä¸‰ä¸ªå‚æ•°çš„å€¼ï¼Œé€šè¿‡è¿™ä¸‰ä¸ªå‚æ•°å°±èƒ½é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º

```jsx
const handler2 = {
  get(trapTarget, prop, receiver) {
    return trapTarget[prop];
  },
};

const proxy2 = new Proxy(target, handler2);
console.log(proxy2.foo); // foo
console.log(target.foo); // foo
```

## 1.3.2 åå°„API

- `Reflect`ä¸ºæ‰€æœ‰**å¯æ‹¦æˆªçš„**ï¼ˆ**interceptable**ï¼‰JavaScriptæ“ä½œæä¾›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å’Œ`proxy` çš„å¤„ç†ç¨‹åºå¯¹è±¡å®Œå…¨ä¸€æ ·ï¼›`Reflect`ä¸æ˜¯ä¸€ä¸ªæ–¹æ³•å¯¹è±¡ï¼Œå®ƒ**ä¸å¯æ„é€ ï¼ˆ**not **constructible**ï¼‰
- æ‰€æœ‰çš„æ•è·å™¨éƒ½èƒ½åŸºäºè‡ªå·±çš„å‚æ•°é‡å»ºåŸå§‹æ“ä½œï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰æ•è·å™¨é‡å»ºåŸå‹æ“ä½œçš„è¿‡ç¨‹éƒ½åƒ`get()` ä¸€æ ·ç®€å•
- å› æ­¤æƒ³è¦é€šè¿‡æ‰‹å†™ä»£ç å®ç°æ¯ä¸ªè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸ºæ˜¯ä¸ç°å®çš„ï¼Œä¸ºæ­¤ECMAScript 6 æä¾›äº†ä¸€ä¸ªå…¨å±€å¯¹è±¡`Reflect` å®ƒå°è£…äº†æ‰€æœ‰åŸºäºå¯¹è±¡æ“ä½œçš„åŸå§‹è¡Œä¸ºï¼Œé€šè¿‡åŒåçš„æ•è·å™¨æ–¹æ³•å°±èƒ½è½»æ¾é‡å»º
- å¤„ç†ç¨‹åºå¯¹è±¡ï¼ˆ`handler`ï¼‰ä¸­çš„æ‰€æœ‰å¯æ•è·çš„æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„**åå°„**ï¼ˆ**Reflect**ï¼‰APIæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸æ•è·å™¨æ‹¦æˆªçš„æ–¹æ³•å…·æœ‰**ç›¸åŒçš„åç§°å’Œå‡½æ•°ç­¾åï¼Œ**è€Œä¸”ä¹Ÿå…·æœ‰ä¸è¢«æ‹¦æˆªæ–¹æ³•ç›¸åŒçš„è¡Œä¸ºã€‚ä½¿ç”¨åå°„APIå¯ä»¥è½»æ¾é‡å»ºè¢«æ‹¦æˆªæ–¹æ³•çš„åŸå§‹è¡Œä¸º

**ä¾‹å­**

```jsx
const target = {
  foo: "bar",
};
const handler = {
  get() {
    return Reflect.get(...arguments);
  },
};
const proxy = new Proxy(target, handler);
console.log(proxy.foo); // bar
console.log(target.foo); // bar
```

- ä¸Šé¢çš„ä¾‹å­å®šä¹‰çš„`handler.get()` æ•è·å™¨ç›´æ¥è¿˜åŸäº†åŸå§‹æ“ä½œç›¸åŒçš„è¡Œä¸ºï¼Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªç©ºä»£ç†å¯¹è±¡
- è¿˜å¯ä»¥å®šä¹‰çš„æ›´ç®€æ´ï¼Œç›´æ¥å°†åå°„çš„`get` èµ‹å€¼ç»™`handler.get`

```jsx
const handler2 = {
  get: Reflect.get,
};
const proxy2 = new Proxy(target, handler2);
console.log(proxy2.foo); // bar
console.log(target.foo); // bar
```

- äº‹å®ä¸Šï¼Œå¦‚æœçœŸæƒ³åˆ›å»ºä¸€ä¸ª**æ•è·æ‰€æœ‰æ–¹æ³•ç„¶åå°†æ‰€æœ‰æ–¹æ³•è½¬å‘ç»™å¯¹åº”åå°„API**çš„ç©ºä»£ç†ï¼Œé‚£ä¹ˆç”šè‡³ä¸éœ€è¦å®šä¹‰å¤„ç†ç¨‹åºå¯¹è±¡ï¼Œç›´æ¥æŠŠReflectå†…ç½®å¯¹è±¡ä½œä¸ºå¤„ç†ç¨‹åºå¯¹è±¡ï¼Œå› ä¸ºReflectä¸Šå®šä¹‰äº†å’Œ`handler`ä¸Šåç§°å®Œå…¨ä¸€æ ·çš„æ–¹æ³•

```jsx
const proxy3 = new Proxy(target, Reflect);
console.log(proxy3.foo); // bar
console.log(target.foo); // bar
```

- å¯ä»¥åœ¨åå°„APIçš„åŸºç¡€ä¸Šæœ€å°‘çš„ä»£ç ä¿®æ”¹æ•è·çš„æ–¹æ³•ï¼Œå¦‚æœåªæ˜¯å¯¹ä¸€äº›æ“ä½œæœ‰äº›è®¸å¾®è°ƒæ—¶ï¼Œåå°„APIä¼šéå¸¸æœ‰ç”¨

```jsx
const target2 = {
  message1: "hello",
  message2: "world",
};
const proxy4 = new Proxy(target2, {
  get(target, prop, receiver) {
    let decoration = "";
    if (prop === "message1") {
      decoration = ", world";
    }
    return Reflect.get(...arguments) + decoration;
  },
});

console.log(proxy4.message1); // hello, world
console.log(target2.message1); // hello
```

- é€šè¿‡åˆ¤æ–­`prop` å¯¹æŒ‡å®šå±æ€§è¿›è¡Œäº†ä¸€ç•ªä¿®é¥°

# 1.4 æ•è·å™¨ä¸å˜å¼ï¼ˆtrap invariantï¼‰

- ä»£ç†ä½¿ç”¨æ•è·å™¨å¯ä»¥æ‹¦æˆªå¯¹å¯¹è±¡çš„æ“ä½œç„¶åé‡å®šä¹‰ï¼Œä½†æ˜¯è¿™ç§é‡å®šä¹‰
- ECMAScriptè§„èŒƒï¼šæ¯ä¸ªæ•è·æ–¹æ³•éƒ½çŸ¥é“ç›®æ ‡å¯¹è±¡ä¸Šä¸‹æ–‡ã€æ•è·å‡½æ•°ç­¾åï¼Œè€Œæ•è·å¤„ç†ç¨‹åºçš„è¡Œä¸ºå¿…é¡»éµå¾ªâ€**æ•è·ä¸å®šå¼ï¼ˆtrap invariantï¼‰**â€œ
- æ•è·å™¨ä¸åŒï¼Œæ¯ä¸ªæ•è·å™¨ä¸å®šå¼ä¹Ÿä¸ç›¸åŒï¼Œä½†éƒ½ä¼šé˜²æ­¢æ•è·å™¨å‡ºç°è¿‡äºåå¸¸çš„è¡Œä¸º
- ä¾‹å¦‚ç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ªä¸å¯é…ç½®ä¸”ä¸å¯å†™çš„æ•°æ®å±æ€§ï¼Œé‚£ä¹ˆ`handler.get()` éµå¾ªçš„æ•è·å™¨ä¸å®šå¼åº”è¯¥æ˜¯è¿”å›ä¸æ”¹å±æ€§ç›¸åŒçš„å€¼ï¼ˆå› ä¸ºè¯¥æ•°æ®å±æ€§çš„ç‰¹æ€§å†³å®šå€¼ä¸å¯å†æ”¹å˜äº†ï¼Œå¦‚æœè·å–åˆ°çš„æ˜¯ä¸€ä¸ªä¸åŸå§‹æ•°æ®ä¸ç›¸åŒçš„æ•°æ®å€¼ï¼Œæ˜¾ç„¶å±äºå¼‚å¸¸äº†ï¼‰
    
    ```jsx
    const target = {};
    // ä¸å¯é…ç½®ä¸å¯å†™çš„å±æ€§ï¼Œvalueå€¼æ˜¯å›ºå®šçš„
    Object.defineProperty(target, "message", {
      value: "hello, world",
      configurable: false,
      enumerable: true,
      writable: false,
    });
    const proxy = new Proxy(target, {
      // æ˜¾ç„¶ä¸éµå¾ªgetçš„æ•è·å™¨ä¸å®šå¼
      get() {
        return "world";
      },
    });
    
    try {
      proxy.message;
    } catch (error) {
      console.log(error.toString()); 
    //  æ‰“å°å¦‚ä¸‹
    TypeError: 'get' on proxy: property 'message' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected 'hello, world' but got 'world')
    }
    ```
    

# 1.5 å¯æ’¤é”€ä»£ç†

- ä½¿ç”¨`new Proxy()`åˆ›å»ºçš„ä»£ç†å¯¹è±¡**é»˜è®¤**æ˜¯ä¸å¯æ’¤é”€çš„ï¼Œå³ä»£ç†ä¸å¯¹è±¡ä¹‹é—´çš„è”ç³»åœ¨å£°æ˜å‘¨æœŸå†…ä¸€ç›´å­˜åœ¨
- æœ‰æ—¶å€™éœ€è¦ä¸­æ–­ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ç§**å¯æ’¤é”€çš„**ï¼ˆ**revocable**ï¼‰ä»£ç†å¯¹è±¡
- `Proxy` æš´éœ²äº†ä¸€ä¸ªé™æ€æ–¹æ³•`Proxy.revocable()` ç”¨äºåˆ›å»ºå¯æ’¤é”€çš„ä»£ç†å¯¹è±¡ï¼Œä¸”æ’¤é”€ä»£ç†åçš„æ“ä½œæ—¶ä¸å¯é€†çš„
- `Proxy.revocable()` è¯­æ³•å¦‚ä¸‹
    
    ```jsx
    const { proxy, revoke } = Proxy.revocable(target, handler)
    ```
    
    - å‚æ•°ï¼š`target`å’Œ`handler` ä¸`Proxy` æ„é€ å‡½æ•°çš„å‚æ•°ç›¸åŒï¼Œä½†æ˜¯è°ƒç”¨æ—¶ä¸ä½¿ç”¨`new` æ“ä½œç¬¦
    - è¿”å›å€¼ï¼Œä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§
        - `proxy` :å¯æ’¤é”€çš„ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰æ’¤é”€ï¼Œæœ¬è´¨ä¸Šå’Œæ™®é€šä»£ç†å¯¹è±¡ä¸€æ ·
        - `revoke` : æ’¤é”€å‡½æ•°ï¼Œè°ƒç”¨å’Œï¼Œä¸å®ƒä¸€å¯¹çš„å¯æ’¤é”€ä»£ç†å¯¹è±¡å°±æ’¤é”€äº†ä¸ç›®æ ‡å¯¹è±¡çš„è”ç³»ï¼Œæ’¤é”€å‡½æ•°æ˜¯å¹‚ç­‰çš„ï¼Œè°ƒç”¨å¤šå°‘æ¬¡ç»“æœéƒ½ä¸€æ ·
    - æ’¤é”€ä»£ç†åå†è°ƒç”¨ä»£ç†ä¼šæŠ›å‡ºTypeErroré”™è¯¯

**ä¾‹å­**

```jsx
// å¯æ’¤é”€ä»£ç†

const target = {
  foo: "bar",
};

const handler = {
  get() {
    return "intercepted";
  },
};

const { proxy, revoke } = Proxy.revocable(target, handler);

console.log(proxy.foo); // intercepted
console.log(target.foo); // bar

// æ’¤é”€ä»£ç†
revoke();

console.log(proxy); // nodeç¯å¢ƒæ‰“å°ä¸º <Revoked Proxy>
try {
  console.log(proxy.message);
} catch (error) {
  console.log(error.message); // Cannot perform 'get' on a proxy that has been revoked
}
```

- åœ¨æµè§ˆå™¨ä¸­çš„æ‰“å°å¦‚ä¸‹
    
    ![tianruo_2022-9-23-637995637345424842.png](1%20%E4%BB%A3%E7%90%86%E5%9F%BA%E7%A1%80/tianruo_2022-9-23-637995637345424842.png)
    
- å¯ä»¥å‘ç°[[Handler]]å’Œ[[Target]] éƒ½æˆç©ºäº†ï¼Œ[[Isrevoked]]è¢«è®¾ç½®ä¸ºtrueï¼Œè¯´æ˜å¤„ç†ç¨‹åºå¯¹è±¡è¢«æŠ›å¼ƒï¼Œä»£ç†å…³è”çš„æºå¯¹è±¡ä¹Ÿä¸å†ä¿ç•™ï¼ŒProxyä»£ç†å·²ä¸æºå¯¹è±¡æ²¡æœ‰ä»»ä½•å…³ç³»äº†

# 1.6 MDN-`Reflect`å†…ç½®å¯¹è±¡æè¿°

[Reflect](1%20%E4%BB%A3%E7%90%86%E5%9F%BA%E7%A1%80/Reflect.md)

# 1.7 å®ç”¨åå°„APIï¼ˆUtility of the Reflect APIï¼‰

- [1.6 å°ç»“](1%20%E4%BB%A3%E7%90%86%E5%9F%BA%E7%A1%80/Reflect.md)ä»‹ç»äº†`Reflect` ä¸­æ‰€æœ‰çš„é™æ€æ–¹æ³•ä»¥åŠå®ƒåœ¨**Object**ä¸­å­˜åœ¨çš„å¯¹åº”åŒåçš„é™æ€æ–¹æ³•
- æŸäº›æƒ…å†µä¸‹ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨åå°„APIï¼ˆReflectçš„é™æ€æ–¹æ³•ï¼‰ï¼ŒåŸå› å¦‚ä¸‹

## 1.7.1 åå°„APIä¸å¯¹è±¡APIï¼ˆReflect API and Object APIï¼‰

**æ·±å…¥**ç†è§£ï¼ˆ**diving into**ï¼‰åå°„APIéœ€è¦è®°ä½çš„ä¸¤ä¸ªç‚¹

1. åå°„APIå¹¶ä¸é™äºæ•è·å¤„ç†ç¨‹åº
2. å¤§å¤šæ•°åå°„APIæ–¹æ³•åœ¨`Object`ç±»å‹ä¸Šæœ‰**ç›¸ä¼¼**çš„æ–¹æ³•ï¼ˆ**analogue**ï¼‰

é€šå¸¸ï¼ŒObjectä¸Šçš„æ–¹æ³•é€‚ç”¨äºé€šç”¨ç¨‹åºï¼Œè€Œ**åå°„æ–¹æ³•é€‚ç”¨äºç»†ç²’åº¦ï¼ˆfine-tunedï¼‰çš„å¯¹è±¡æ§åˆ¶ä¸æ“ä½œï¼ˆmanipulationï¼‰**

## 1.7.2 çŠ¶æ€æ ‡è®°

- åœ¨1.6 ä¸­é˜è¿°åå°„APIä¸å¯¹è±¡APIçš„ä¸åŒæ—¶ï¼Œä¸€ä¸ªå…³é”®ä¸åŒå°±æ˜¯åŠŸèƒ½ç›¸åŒçš„é™æ€æ–¹æ³•ï¼Œ**è¿”å›å€¼ä¸åŒ**
- å¾ˆå¤šåå°„æ–¹æ³•è¿”å›ç§°ä½œâ€œ**çŠ¶æ€æ ‡è®°ï¼ˆstatus flagï¼‰**â€çš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ„å›¾æ‰§è¡Œçš„æ“ä½œæ˜¯å¦æˆåŠŸï¼Œè¿™æ¯”æœ‰äº›è¿”å›ä¿®æ”¹åçš„ç›®æ ‡å¯¹è±¡çš„Objecté™æ€æ–¹æ³•æˆ–æŠ›å‡ºé”™è¯¯çš„æ–¹æ³•æ›´æœ‰ç”¨å¤„
- å¦‚ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨Object APIå®šä¹‰å±æ€§çš„ä¾‹å­
    
    ```jsx
    const o = {};
    try {
      Object.defineProperty(o, "foo", {
        value: "bar",
      });
      console.log("success");
    } catch (error) {
      console.log("failure");
    }
    ```
    
    - ä¸Šé¢ç®€å•å±•ç¤ºæ˜¾ç„¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä½†æ˜¯åœ¨`[Object.defineProperty()](../8%20%E5%AF%B9%E8%B1%A1%E3%80%81%E7%B1%BB%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/1%20%E7%90%86%E8%A7%A3%E5%AF%B9%E8%B1%A1.md)` ä¸­ï¼Œå¦‚æœå®šä¹‰æ—¶å‘ç”Ÿé—®é¢˜ï¼Œæ˜¾ç„¶ä¼šæŠ›å‡ºé”™è¯¯è€Œä¸æ˜¯è¿”å›false
- ä½¿ç”¨`Reflect.defineProperty()` å¯ä»¥é‡æ„ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ä¿è¯ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œåè€Œå› ä¸ºè¿”å›å€¼å¯ä»¥ç»™å‡ºçŠ¶æ€æ ‡è®°æ›´ä¾¿äºç¼–å†™ç¨‹åº
    
    ```jsx
    const o = {};
    if (
      Reflect.defineProperty(o, "foo", {
        value: "bar",
      })
    ) {
      console.log("success");
    } else {
      console.log("failure");
    }
    ```
    
- ä»¥ä¸‹åå°„æ–¹æ³•éƒ½ä¼šæä¾›çŠ¶æ€æ ‡è®°
    - `Reflect.defineProperty()`
    - `Reflect.preventExtensible()`
    - `Reflect.setPrototypeOf()`
    - `Reflect.set()`
    - `Reflect.deletePrototype()`
    - è¯¦ç»†ä»‹ç»å¯ä»¥æŸ¥çœ‹[Reflect](1%20%E4%BB%A3%E7%90%86%E5%9F%BA%E7%A1%80/Reflect.md)

## 1.7.3 ç”¨ä¸€ç­‰å‡½æ•°æ›¿ä»£æ“ä½œç¬¦ï¼ˆSupplanting Operators with First-Class Functionsï¼‰

- Supplanting å³æ›¿ä»£ï¼ŒFirst-Class è¡¨ç¤ºä¼˜ç§€ï¼ŒReflectçš„ä¸€äº›é™æ€æ–¹æ³•æ‹¥æœ‰å’Œä¸€äº›æ“ä½œç¬¦ç›¸åŒçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹
    - `Reflect.get()`: å¯ä»¥æ›¿ä»£å¯¹è±¡å±æ€§è®¿é—®æ“ä½œç¬¦
    - `Reflect.set()`: å¯ä»¥æ›¿ä»£`=`èµ‹å€¼æ“ä½œç¬¦ï¼ˆassignment operatorï¼‰
    - `Reflect.has()` : å¯ä»¥æ›¿ä»£`in` æ“ä½œç¬¦æˆ–`with()`
    - `Reflect.deleteProperty()` :å¯ä»¥æ›¿ä»£`delete`æ“ä½œç¬¦
    - `Reflect.construct()` :å¯ä»¥æ›¿ä»£`new`æ“ä½œç¬¦

## 1.7.4 å®‰å…¨åœ°åº”ç”¨å‡½æ•°

- å‡½æ•°ä½œä¸ºä¸€ä¸ªå¯¹è±¡å¯ä»¥é€šè¿‡`apply` æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œæ–¹ä¾¿æŒ‡å®š`this`
- ä½†æ˜¯è¢«è°ƒç”¨åœ°å‡½æ•°å¯èƒ½å®šä¹‰äº†è‡ªå·±çš„`apply`å±æ€§ ï¼ˆå¯èƒ½æ€§æå°ï¼‰ï¼Œè¿™æ ·å°±ä¸èƒ½ä½¿ç”¨åŸå‹ä¸Šçš„`apply`æ–¹æ³•äº†
- ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å®šä¹‰åœ¨FunctionåŸå‹ï¼ˆprototypeï¼‰ä¸Šçš„`apply`æ–¹æ³• ï¼Œæ¯”å¦‚
    
    ```jsx
    // å®‰å…¨åº”ç”¨å‡½æ•°
    function foo() {
      console.log("foo");
    }
    foo.apply();
    // è‡ªå®šä¹‰applyå¯¼è‡´è°ƒç”¨æ—¶äº§ç”Ÿé—®é¢˜
    foo.apply = function (thisArg, ...rest) {
      console.log("bar");
    };
    foo.apply();
    
    // ä½¿ç”¨FunctionåŸå‹ä¸Šçš„applyæ–¹æ³•
    **Function.prototype.apply.call(foo);**
    ```
    
- ä½†æ˜¯ä»£ç è¿‡é•¿ï¼Œè¿˜éœ€è¦è°ƒç”¨applyçš„callæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`Reflect.apply()`æ¥é¿å…
    
    ```jsx
    // ä½†æ˜¯è¿™å¤ªéº»çƒ¦äº†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Reflectçš„API
    Reflect.apply(foo, null, []);
    ```
    
    - å”¯ä¸€ç¼ºç‚¹æ˜¯è¢«è°ƒç”¨å‡½æ•°å‚æ•°ä¸ºç©ºä¹Ÿè¦ä¿è¯ä¼ é€’ç©ºå‚æ•°æ•°ç»„è¿‡å»

# 1.8 ä»£ç†å¦ä¸€ä¸ªä»£ç†(Proxying a Proxy)

- ä»£ç†å¯ä»¥æ‹¦æˆªï¼ˆinterceptingï¼‰åå°„APIçš„æ“ä½œï¼Œè¿™æ„å‘³ç€å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œé€šè¿‡å®ƒå»ä»£ç†å¦å¤–ä¸€ä¸ªä»£ç†
- è¿™æ ·å°±å¯ä»¥åœ¨å•ä¸ªç›®æ ‡å¯¹è±¡ä¸Šæ„å»ºå¤šå±‚æ‹¦æˆªç½‘ï¼ˆmultiple layers of **indirection**ï¼‰
    - **indirection:**é—´æ¥**ï¼Œ**è¡¨ç¤ºé€šè¿‡ä»£ç†ä¸€ä¸ªä»£ç†äº†ç›®æ ‡å¯¹è±¡çš„ä»£ç†ä»è€Œé—´æ¥ä»£ç†ç›®æ ‡å¯¹è±¡

```jsx
const target = { foo: "bar" };

const firstProxy = new Proxy(target, {
  get() {
    console.log("frist proxy");
    return Reflect.get(...arguments);
  },
});

const secondProxy = new Proxy(firstProxy, {
  get() {
    console.log("second proxy");
    return Reflect.get(...arguments);
  },
});

console.log(secondProxy.foo);
// second proxy
// frist proxy
// bar
console.log(firstProxy.foo);
// frist proxy
// bar
```

- åœ¨æ‰§è¡Œ`secondProxy.foo`æ—¶ï¼Œå®ƒä¼šæ‹¦æˆª`firstProxy`çš„`get`æ“ä½œï¼Œç„¶åæ‰§è¡Œ`secondProxy`è‡ªå·±çš„`get`æ“ä½œæ‰“å°å‡º`"second proxy"`  ,æ­¤æ—¶å®ƒçš„`arguments` å‚æ•°ä¸­æ˜¯ `(firstProxy, "foo", secondProxy)`
- ç„¶åå†æ‰§è¡Œ`Reflect.(firstProxy, "foo", secondProxy)` ï¼Œç›¸å½“äºè·å–`firstProxy.foo` ï¼Œå®ƒä¼šæ‹¦æˆª`target` çš„`get`æ“ä½œï¼Œç„¶åæ‰§è¡Œ`firstProxy` è‡ªå·±çš„`get`æ“ä½œæ‰“å°å‡º`"first proxy"` ï¼Œæœ€åæ‰§è¡Œ`Reflect.get(target, "foo", firstProxy)` è·å–åˆ°ç›®æ ‡å¯¹è±¡ä¸­çš„å€¼

# 1.9 ä»£ç†çš„é—®é¢˜ä¸ä¸è¶³ï¼ˆConsiderations and Shortcomingsï¼‰

ä»£ç†æ˜¯åœ¨ECMAScriptç°æœ‰**åŸºç¡€**ï¼ˆ**infrastructure**ï¼‰ä¸Šæ„å»ºèµ·æ¥çš„ä¸€å¥—æ–°APIï¼Œå…¶å®å·²ç»å°½åŠ›åšåˆ°å¾ˆå¥½äº†ï¼Œä»£ç†ä½œä¸ºå¯¹è±¡çš„è™šæ‹Ÿå±‚ï¼ˆvirtualization layerï¼‰å¯ä»¥æ­£å¸¸ä½¿ç”¨

ä½†æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä»£ç†ä¸èƒ½ä¸ç°æœ‰çš„ECMAScript**æ„é€ **ï¼ˆ**constructs**ï¼‰è¿›è¡Œå¾ˆå¥½çš„**ååŒ**ï¼ˆ**integrate**ï¼‰

## 1.9.1 ä»£ç†ä¸­çš„this

- ä»£ç†æ½œåœ¨çš„ä¸€ä¸ªé—®é¢˜æ¥æºæ˜¯`this`å€¼
- ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ–¹æ³•ä¸­çš„`this` æŒ‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ï¼Œå¦‚ä¸‹
    
    ```jsx
    const target = {
      thisValEqualProxy() {
        return this === proxy;
      },
    };
    const proxy = new Proxy(target, {});
    console.log(target.thisValEqualProxy()); // false
    console.log(proxy.thisValEqualProxy()); // true
    ```
    
    - é€šè¿‡`proxy`è°ƒç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆæ–¹æ³•ä¸­çš„`this`å°±æ˜¯`proxy` å¯¹è±¡ï¼Œè¿”å›`true`
    - é€šè¿‡`target` è°ƒç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆæ–¹æ³•ä¸­çš„`this` å°±æ˜¯`target`å¯¹è±¡ï¼Œè¿”å›`false`
- æ‰€ä»¥ä»ç›´è§‰ä¸Šæ¥æ‰€ï¼Œè¿™æ ·åœ¨ä»£ç†è°ƒç”¨æ—¶å°†æ–¹æ³•çš„`this`è®¾ç½®ä¸ºä»£ç†å¯¹è±¡æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼š
    - è°ƒç”¨`proxy.outerMethod()` `this`æŒ‡è¢«æŒ‡å‘ä¸º`proxy`
    - è€Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚`this.innerMethod()` ï¼Œå› ä¸º`this` æŒ‡å‘`proxy` çš„ç¼˜æ•…ï¼Œä¼šè°ƒç”¨`proxy.innerMethod()` å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç¬¦åˆé¢„æœŸçš„
    - ~~è¿™æ ·ä¿è¯`this`å€¼ç»Ÿä¸€ï¼Œå¦‚æœä½¿ç”¨proxyè°ƒç”¨æ–¹æ³•thisè¢«æŒ‡ä»£`target` ,è¿™ä¼šå¯¼è‡´æ–¹æ³•å†…å¯¹targetçš„å…¶ä»–å±æ€§è°ƒç”¨ä¸ç»è¿‡ä»£ç†ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡targetè®¿é—®ï¼Œè¿™ä¸ç¬¦åˆä»£ç†åº•å±‚çš„å®ç°æ„ä¹‰~~
- å¦‚æœç›®æ ‡å¯¹è±¡ä¾èµ–äºå¯¹è±¡æ ‡è¯†ï¼ˆobject identityï¼‰ï¼Œå°±ä¼šç¢°åˆ°æ„æ–™ä¹‹å¤–çš„é—®é¢˜
- ä¸€ä¸ªå…¸å‹çš„éœ€è¦ä¾èµ–å¯¹è±¡æ ‡è¯†çš„åœºæ™¯æ˜¯ï¼šä½¿ç”¨WeakMapä¿å­˜ç§æœ‰å˜é‡ï¼Œå¦‚ä¸‹
    
    ```jsx
    let Person;
    {
      const privateScope = new WeakMap();
      Person = function (name, id) {
        this.name = name;
        this.setIDNum(id);
      };
      Person.prototype.getIDNum = function () {
        return privateScope.get(this)["id"];
      };
      Person.prototype.setIDNum = function (val) {
        const privateMembers = privateScope.get(this) || {};
        privateMembers["id"] = val;
        privateScope.set(this, privateMembers);
      };
    }
    console.log(typeof privateScope); // undefined 
    
    const person = new Person("mangwu", "421023yyyymmdd1234");
    console.log(person); // PersonÂ {name: 'mangwu'}
    // å…¬å…±å±æ€§å¯ä»¥ç›´æ¥å¥ç‚¹è°ƒç”¨ä¿®æ”¹
    person.name = "wumang";
    person.setIDNum("421023yyyymmdd4567");
    console.log(person.getIDNum()); // 421023yyyymmdd4567
    ```
    
    - è¿™ä¸ªä¾‹å­ä¸­æ˜¯é€šè¿‡`WeakMap`è®°å½•æ¯ä¸ª`Person`å®ä¾‹çš„`id`çš„ï¼Œè€Œ**è®°å½•ä¾èµ–Personå®ä¾‹çš„å¯¹è±¡æ ‡è¯†ï¼Œ**å³`privateScope.set(this, privateMembers);` å’Œ`return privateScope.get(this)["id"];` æ—¶ï¼Œ`this` çš„å€¼éœ€è¦å›ºå®šä¸‹æ¥ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ä»£ç†å’Œ`target`å®ä¾‹æ‹¥æœ‰ä¸åŒçš„`id` ï¼Œå¦‚ä¸‹
    
    ```jsx
    const proxyPerson = new Proxy(person, {});
    try {
      console.log(proxyPerson.getIDNum()); // å› ä¸ºthisæŒ‡å‘proxyæœ¬èº«ï¼Œæ‰€ä»¥ä¸å­˜åœ¨id
    } catch (error) {
      // æŠ¥é”™åŸå› æ˜¯privateScope.get(this)çš„ç»“æœæ˜¯undefinedï¼Œå†è®¿é—®å…¶ä¸­çš„idå¿…ç„¶å‡ºé”™
      console.log(error.toString()); // TypeError: Cannot read properties of undefined (reading 'id')
    }
    proxyPerson.setIDNum("321421yyyymmdd1234"); // å› ä¸ºthisæŒ‡å‘proxyæœ¬èº«ç›¸å½“äºå†wmæ·»åŠ äº†ä¸€ä¸ªæ–°id
    console.log(proxyPerson.getIDNum()); // è¿™ä¸ªidæ˜¯proxyåˆå†wmä¸­ä½œä¸ºé”®æ–°å»ºçš„id 321421yyyymmdd1234
    console.log(person.getIDNum()); // å®ä¾‹æœ¬èº«çš„idå…¶å®å¹¶æ²¡æœ‰æ”¹å˜ 421023yyyymmdd4567
    ```
    
    - å› ä¸ºè¿™ç§ç§æœ‰å±æ€§çš„**å®ç°**ï¼ˆ**implementation**ï¼‰ä¸€å¼€å§‹å°±ä¾èµ–äºPersonå®ä¾‹çš„**å¯¹è±¡æ ‡è¯†**ï¼ˆ**object identity**ï¼‰ï¼Œå½“Personå¯¹è±¡å®ä¾‹è¢«ä»£ç†åå¿…ç„¶å‡ºç°è¿™ç§æƒ…å†µï¼›åœ¨å¯¹è±¡ä»£ç†è§†å›¾é€šè¿‡ä»£ç†**æœ¬èº«**ï¼ˆproxy objectï¼‰**æ£€ç´¢ï¼ˆretrieveï¼‰**idæ—¶ï¼Œ wmä¸­åªæœ‰è¢«åˆå§‹åŒ–ä¸ºPersonå®ä¾‹çš„keyå€¼ï¼Œå¿…ç„¶è¿”å›undefinedæˆ–æŠ›å‡ºé”™è¯¯
    - è§£å†³æ–¹æ³•æ˜¯ï¼š**é‡å†™é…ç½®**ï¼ˆ**reconfigure**ï¼‰ä»£ç†ï¼ŒæŠŠ`WeakMap` ä¸­çš„`key` æ’å…¥ï¼ˆinsertionï¼‰çš„åˆå§‹åŒ–è®¾ç½®ä¸ºä»£ç†å®ä¾‹â€”é€šè¿‡ä»£ç†æ„é€ å‡½æ•°ï¼ˆç±»ï¼‰æœ¬èº«ï¼Œç„¶åå®ä¾‹åŒ–ï¼ˆinstantiatingï¼‰ä»£ç†çš„æ„é€ å‡½æ•°ï¼ˆç±»ï¼‰ï¼›è¿™æ ·ä¿è¯äº†å®ä¾‹åŒ–æ—¶çš„`this` æ˜¯ä»£ç†å®ä¾‹è€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡
    
    ```jsx
    // è§£å†³æ–¹æ³•ï¼Œç›´æ¥ä»£ç†æ„é€ å‡½æ•°
    const PersonProxy = new Proxy(Person, {});
    const proxyPerson2 = new PersonProxy("mangwu", "321421yyyymmdd1234");
    console.log(proxyPerson2); // Person { name: 'mangwu' }
    console.log(proxyPerson2.getIDNum()); // 321421yyyymmdd1234
    ```
    

## 1.9.2 ä»£ç†ä¸å†…éƒ¨æ§½ä½ï¼ˆInternal Slotsï¼‰

- å…³äº**å†…éƒ¨æ§½ä½ï¼ˆInternal Slotsï¼‰**
    - æœ‰äº›åœ°æ–¹ç¿»è¯‘ä¸º**å†…éƒ¨æ’æ§½**ï¼ˆæ›´åˆé€‚ï¼‰ï¼Œåœ¨å¯¹è±¡çš„åŸå‹å­¦ä¹ ä¸­å·²ç»æ¥è§¦è¿‡äº†ï¼Œå°±æ˜¯æ¯ä¸ªå¯¹è±¡ï¼ˆ**ordinary object** æ™®é€šå¯¹è±¡ä¸åŒ…æ‹¬ç‰¹æ®Šçš„ï¼‰éƒ½æœ‰ä¸€ä¸ªåä¸º[[Prototype]]çš„**å†…éƒ¨æ’æ§½**ï¼Œåœ¨JavaScriptä¸­ç†è§£ä¸ºå¯¹è±¡çš„åŸå‹å¯¹è±¡
    - é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„**å†…éƒ¨æ’æ§½**ï¼Œåœ¨ä»‹ç»`Reflect.isExtensible()` æ—¶ä¹Ÿæåˆ°è¿‡ï¼Œå°±æ˜¯[[Extensible]]å†…å­˜æ’æ§½ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºå®ç°ä¸å¯æ‰©å±•æ€§ç›¸å…³çš„å†…éƒ¨æ–¹æ³•
    - **å†…éƒ¨æ’æ§½æ˜¯ESè§„èŒƒå†…éƒ¨å®šä¹‰çš„ä¸€ç³»åˆ—ä¼ªå±æ€§ï¼ˆpseudo-propertyï¼‰ï¼Œæ— æ³•é€šè¿‡jsè®¿é—®åˆ°ï¼Œåªèƒ½ä½œä¸ºå¼•æ“è¿è¡ŒJSä»£ç æ—¶çš„å†…éƒ¨å±æ€§è€Œå­˜åœ¨ã€‚å†…éƒ¨æ’æ§½ä½œä¸ºä¸€ç§ä¼ªå±æ€§è®°å½•çš„æ˜¯æ•°æ®/çŠ¶æ€ï¼Œè€Œä¸æ˜¯è®°å½•çš„æ–¹æ³•ï¼Œä¼ªå±æ€§çš„æ–¹æ³•è®°å½•åœ¨å†…éƒ¨æ–¹æ³•ä¸­ã€‚åœ¨è§„èŒƒä¸­ï¼Œç”¨[[]]åŒé‡ç¬¦å·åŒ…è£¹èµ·æ¥çš„å°±æ˜¯å†…éƒ¨æ’æ§½/æ–¹æ³•**
    - æƒ³è¦ç†è§£å†…éƒ¨æ’æ§½ï¼Œå¯ä»¥è¯»TC39å…³äºESçš„[è§„èŒƒ](https://tc39.es/)ï¼Œ ä¹Ÿå¯ä»¥äº†è§£V8å¼•æ“å¯¹äºECMAScriptå®ç°è®°å½•çš„[åšå®¢](https://v8.dev/blog/understanding-ecmascript-part-1)
- ä»£ç†å’Œå†…ç½®å¼•ç”¨ç±»å‹ï¼ˆå¦‚Arrayï¼‰çš„å®ä¾‹é€šå¸¸å¯ä»¥å¾ˆå¥½çš„ååŒï¼Œä½†æ˜¯æœ‰äº›ECMAScriptå†…ç½®ç±»å‹å¯èƒ½ä¼šä¾èµ–ä»£ç†æ— æ³•æ§åˆ¶çš„**æœºåˆ¶**ï¼ˆ**mechanisms**ï¼‰ï¼Œç»“æœå¯¼è‡´åœ¨ä»£ç†ä¸Šè°ƒç”¨æŸäº›æ–¹æ³•ä¼šå‡ºé”™
- ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯`Date`ç±»å‹
    - ECMAScriptè§„èŒƒï¼Œ`Date`ç±»å‹æ–¹æ³•æ‰§è¡Œä¾èµ–`this`å€¼ä¸Šçš„**å†…éƒ¨æ§½ä½**[[NumberDate]]
    - ä»£ç†äº†ä¸€ä¸ª`Date` å®ä¾‹çš„ä»£ç†å¯¹è±¡ä¸Š**ä¸å­˜åœ¨**è¿™ä¸ªå†…éƒ¨æ§½ä½ï¼Œè€Œä¸”è¿™ä¸ªå†…éƒ¨æ§½ä½çš„å€¼ä¹Ÿä¸èƒ½é€šè¿‡æ™®é€šçš„`get()`å’Œ`set()` æ“ä½œè®¿é—®åˆ°ï¼Œäºæ˜¯ä»£ç†æ‹¦æˆªåæœ¬åº”è¯¥è½¬å‘ç»™ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä¼šæŠ›å‡º`TypeError`
        
        ```jsx
        const target = new Date();
        const proxy = new Proxy(target, {});
        
        console.log(proxy instanceof Date); // true
        try {
          proxy.getDate(); // æ— æ³•è·å–
        } catch (error) {
          console.log(error.toString()); // TypeError: this is not a Date object.
        }
        ```
        
        - `Date` å®ä¾‹è°ƒç”¨æ–¹æ³•ä¾èµ–[[NumberDate]]
        - è€Œ`proxy`è°ƒç”¨æ–¹æ³•æ—¶ä½¿ç”¨`proxy`æœ¬èº«ä½œä¸º`this` ,è¿™ä¸ª`this`æ²¡æœ‰[[NumberDate]] ä¸”å› ä¸ºå†…éƒ¨æ’æ§½**æ— æ³•é€šè¿‡jsè®¿é—®åˆ°ï¼Œåªèƒ½ä½œä¸ºå¼•æ“è¿è¡ŒJSä»£ç æ—¶çš„å†…éƒ¨å±æ€§è€Œå­˜åœ¨ï¼Œ**æ‰€ä»¥æŠ›å‡ºé”™è¯¯