# 捕获组

参考[csdn](https://blog.csdn.net/johnf_nash/article/details/78570836)

# 1. 概述

## 1.1 捕获组定义

- 捕获组，capture groups ，就是把正则表达式中子表达式的匹配的内容，保存到内存中以**数字编号或显式命名的组**里，方便后面引用
    - 数字编号的形式就是在匹配返回的数组信息中按照编号排列匹配字符串
    - 显式命名就是在匹配数组中以`groups` 属性值的方式保存
- 捕获组有两种定义方式
    - 普通捕获组，通常的捕获组就是普通捕获组，使用小括号将子正则表达式括起来
        
        ```jsx
        (Expression)
        ```
        
        - 正则表达式中的小括号是一种元符号，有特殊含义
        - 使用括号将正则中模式的部分表达式括起来，括起来的部分匹配到的字符就是一个捕获组
    - 命名捕获组
        
        ```jsx
        (?<name>Exprssion)
        ```
        
        - 命名捕获组同样有数字编号，只是额外增加了对捕获组的命名
- 支持捕获组的语言
    - 普通捕获组在大部分支持正则表达式的语言或工具中都支持
    - 命名捕获组只在.NET,PHP,Python，JavaScript等语言中支持
    - 在.NET语言中的命名捕获组还可以使用`(?"name"Expression)` 的方式定义

## 1.2 捕获组编号规则

编号规则指以数字为捕获组进行编号的规则，正则表达式中**只有**普通捕获组或者命名捕获组，则编号规则比较清晰：**编号0为整个正则表达式整体，之后的编号按照左括号的顺序逐一增加**

### 1.2.1 普通捕获组的编号规则

- 按照左括号在模式中出现的顺序来编号捕获组，即按照”(”的出现顺序，从左到右，从1开始编号
- 例如简单日期（未做数字范围判断）的正则表达式`/(\d{4})-((\d{2})-(\d\d))/`
    - 以2022-07-01为例
    
    | 编号 | 命名 | 捕获组 | 匹配内容 |
    | --- | --- | --- | --- |
    | 0 |  | (\d{4})-((\d{2})-(\d\d)) | 2022-07-01 |
    | 1 |  | (\d{4}) | 2022 |
    | 2 |  | ((\d{2})-(\d\d)) | 07-01 |
    | 3 |  | (\d{2}) | 07 |
    | 4 |  | (\d\d) | 01 |

### 1.2.2 命名捕获组编号规则

- 如果正则模式的捕获组数量过多，那么一个个去数编号然后获取捕获组的匹配内容难免产生错误，而且正则表达式在后续扩展修改的过程中，编号可能随之改变，所以命名捕获组很有必要
- 命名捕获组可以通过命名访问到指定的组，注意不能重名
- 同时命名捕获组也参与了捕获组的编号，在只有命名捕获组的情况下，编号也是按照”(”出现的顺序，从左到右，从1开始编号的
- 例如，将上述的简单日期的每个未命名的捕获组进行命名：`/(?<year>\d{4})-(?<date>(?<month>\d{2})-(?<day>\d\d))/`
    - 以2022-07-01为例
    
    | 编号 | 命名 | 捕获组 | 匹配内容 |
    | --- | --- | --- | --- |
    | 0 |  | (?<year>\d{4})-(?<date>(?<month>\d{2})-(?<day>\d\d)) | 2022-07-01 |
    | 1 | year | (?<year>\d{4}) | 2022 |
    | 2 | date | (?<date>(\d{2})-(\d\d)) | 07-01 |
    | 3 | month | (\d{2}) | 07 |
    | 4 | day | (\d\d) | 01 |

### 1.2.3 普通捕获组与命名捕获组混合编号规则

- 普通捕获组合命名捕获组混合出现时，捕获组的编号规则就有变化了
    - 首先按照普通捕获组中”(”出现的先后顺序，从左到右，从1开始编号
    - 当普通捕获组编号完成后，再按照命名捕获组中”(”出现的先后顺序从左到右，接着普通捕获组的编号继续进行编号
- 例如，将上述的简单日期正则，一部分不命名，一部分命名：**`/(\d{4})-(?<date>(\d{2})-(?<day>\d\d))/`**
    - 以2022-07-01为例
    
    | 编号 | 命名 | 捕获组 | 匹配内容 |
    | --- | --- | --- | --- |
    | 0 |  | (\d{4})-((\d{2})-(\d\d)) | 2022-07-01 |
    | 1 |  | (\d{4}) | 2022 |
    | 3 | date | (?<date>(\d{2})-(?<day>\d\d)) | 07-01 |
    | 2 |  | (\d{2}) | 07 |
    | 4 | day | (?<day>\d\d) | 01 |
- 注意，实际上再JavaScript中，使用exec()实例方法对字符串进行匹配时，捕获组的编号不会区分不同捕获组和命名捕获组，仍然按照左括号的顺序进行编号

# 2. 捕获组的引用

## 引用的方式

- 捕获组的引用方式有三种
    1. 在正则表达式中，对前面捕获组的内容进行引用，称为反向引用
    2. 在正则表达式中，`(?(name)yes|no)` 的条件判断结构引用
    3. 在程序中，对捕获组的（匹配的）内容进行引用

## 2.1 反向引用

- 在正则表达式模式内部将捕获组进行引用的方式就是反向引用
- 反向引用作用通常用来**查找或限定重复，限定指定标识配对出现等**

### 2.1.1普通捕获组的反向引用

```jsx
\k<number> 通常简写为\number
```

- number是十进制的数字，即捕获组的编号
- JavaScript暂时不支持\k<number>的写法
- 使用\number 进行匹配时，匹配的内容一定和指定编号的捕获组内容一样

```jsx
const pattern5 = /(\d{4})-((\d{2})-\3)/;
console.log(pattern5.exec("2022-07-07"));
```

- `\3` 会匹配第三个捕获组的内容，第三个捕获组匹配到“07”，所以\3也匹配”07”（不能匹配到其他的）

### 2.2.2命名捕获组的反向引用

```jsx
\k<name>或者\k"name"
```

- JavaScript不支持双引号，只支持第一种个
- name是捕获组的名称

```jsx
const pattern6 = /(\d{4})-((?<month>\d{2})-\k<month>)/;
console.log(pattern6.exec("2022-07-07"));
```

- `\k<month>` 匹配命为month的捕获组的内容

## 2.2 条件判断结构引用

```jsx
(?(name)yes|no) 或者(?(expression)yes|no)
```

- 对于`(?(expression)yes|no)` 它是**`(?(?=Expression)yes|no)`** 的简写模式，相当于三元运算符**`(?=Expression) ? yes : no`**
- 如果子表达式`?=expression` 匹配成功则匹配yes子表达式，否则匹配no子表达式
    - 如果expression的表达式和可能出现的命名捕获组组名相同，避免混淆，建议使用**`(?(?=Expression)yes|no)`**
- 例子
    - 字符串abc
    - 正则表达式`(?(?=a)\w{2}|\w)`
    - 如果当前位置右侧是字符a，则匹配两个`\w` 否则匹配一个`\w`
        
        ```vbnet
        string test = "abc";
        
        Regex reg = new Regex(@"(?(?=a)\w{2}|\w)");
        
        MatchCollection mc = reg.Matches(test);
        
        foreach(Match m in mc)
        
        {
        
             richTextBox2.Text += m.Value + "\n";
        
        }
        
        /*--------输出--------
        
        ab
        
        c
        
        */
        ```
        
- **在JavaScript中似乎并不支持这种语法**

## 2.3 程序中的引用

- 在不同的程序中，捕获组的引用方式不同

### 2.3.1 JavaScript中的引用

- JavaScript在程序中的引用一般在**替换和匹配**时使用

**1) 在String.prototype.replace()中引用**

- 通过$number的方式引用，number是捕获组的编号
    
    ```jsx
    const pattern7 = /<([a-z]+)[^>]*>/gi;
    console.log(
      "<table id='test'><tr class='tr-row'><td id='td-cell'>test</td></tr>".replace(
        pattern7,
        "<$1>"
      )
    );
    ```
    
    - `/<([a-z]+)[^>]*>/gi` 能匹配所有的带任何属性的规则html标签，例如上面的table标签，带有id属性
    - 使用replace能够匹配字符串中的内容，然后替换成指定的字符，第二个参数就是替换的字符串
    - 第二个参数可以传入第一个参数（正则表达式）的捕获组编号，以替换成子表达式捕获组的内容
    - 上述的例子将匹配的内容替换成了只有标签，没有属性的html标签，使用$1表示捕获组编号
- 也可以使用$name的方式引用，name是捕获组的名称
    
    ```jsx
    const pattern7 = /<(?<tag>[a-z]+)[^>]*>/gi;
    console.log(
      "<table id='test'><tr class='tr-row'><td id='td-cell'>test</td></tr>".replace(
        pattern7,
        "<$<tag>>"
      )
    );
    ```
    
    - 同使用$number，只是定义并使用了捕获组名称

**2) 匹配时引用，通过RegExp.$number的方式进行引用**

- 在使用test()匹配时
    
    ```jsx
    const pattern8 = /(\d{4})-((?<month>\d{2})-(?<day>\d{2}))/;
    console.log(
      pattern8.test("2012-07-04"),
      RegExp.$1,
      RegExp.$2,
      RegExp.$3,
      RegExp.$4
    );
    ```
    
    - 打印结果`true 2012 07-04 07 04`
- 在新的版本的node中，$number的引用方式已被弃用（但仍然有效）